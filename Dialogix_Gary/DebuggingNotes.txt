9/25/2007

Re-commented all Evidence code so that only TricepsTimingCalculator is called:

Errors
(1) RawData not updated
(2) EnglishFrenchDemo not updated
(3) InstrumentSession not updated
(4) PageHitEvents - only partially updated
(5) PageHit updated, but wrong times

Instrument_Session_ID is 0 before most errors

Updates do occur (enough? - compare to without comments) - is problem just session ID?

-----
9/26/2007

data.MysqlInstrumentSessionDAO->setInstrumentSession:63 - instrument_id = 0 - is that session? instrument?

-----
9/30/2007

Unicode Debugging Notes
(1) MySQL does accurately store Unicode text (russian, Hebrew) if use PHPMyadmin to enter and save it.  So Mysql will be fine once can load proper data into it.
(2) Velocity Macros also print proper text (so Java Parser is working)
(3) .dat files show proper Unicode (whether using UTF-16 or UTF-8)
(4) .dat.evt are wrong - JavaScript 1.2 (the version I was using) does not support Unicode. When I declare JavaScript 1.5, no change
(5) Need to test Mysql drivers for unicode compatability (e.g. load results of Velocity Macros into a table
(6) Entering UTF-8 into any input field (text, memo) yields wrong answer.  Unicode in non-text fieds is fine, but may be due to using internal coded values in return statements
(5) 

------
10/5/2007

Database Writing
- Seems to be largely fixed (no NullPointerException; one row per desired session; updates are happening)
- However, there are many wrong or missing values which need to be corrected
- Make sure to CVS this before doing much more!

Unicode
- UTF-16 to Log4J let me see some contents correctly, confirming that error is not on Log4J side

------
10/7/2007

Notes from running the Gary's revised code

(1) EnglishRussianFrenchHebrew
(2) InstrumentSession
(3) PageHitEvents
(4) PageHits
(5) RawData

-- Note, can't use on update CURRENT_TIMESTAMP on two rows, so application must enforce accurate start and end times.
-- N.B.  Focus on InstrumentSession, InstrumentSessionData, and RawData - Ignore PageHits and PageHitEvents for now!!!!

// InstrumentSessionDataDAO
englishrussianfrenchhebrew
  InstrumentName - OK
  InstanceName - OK
  StartTime - OK 
  end_time - OK
  first_group - OK
  last_group - OK
  last_action - OK
  status_message - OK
  instrument_session_id - OK
  <DisplayNum> - OK

// InstrumentSessionDAO
instrument_session
  instrument_session_id - OK
  start_time - OK
  end_time - OK
  instrument_id - OK
  instrument_version_id - OK
  user_id - OK (but N/A)	/skip
  first_group - OK
  last_group - OK
  last_action - OK
  statusMsg - OK
  <DisplayNum> - OK

// PageHitEventsDAO (?)
pagehitevents 
  pageHitEventsID - OK
  pageHitID - OK	
  varName - OK
  actionType - OK
  eventType - OK
  `timestamp` - OK
  duration - OK
  value1 - OK	// except no Unicode, and change events aren't showing the final value after series of keypresses
  value2 - OK	// except no Unicode

// PageHitsDAO (?)
pagehits 
  pageHitID - OK
  instrument_session_id - OK (always 0)	/FIXME
  `timeStamp` - OK
  groupNum - OK	/FIXME (is it really OK?)
  displayNum - OK - at least first several are - accessCount is better	/FIXME
  lastAction - OK (but present)	/skip
  statusMsg - OK
  totalDuration - WRONG (huge)	/FIXME (last entry in EVENT_TIMING)
  serverDuration - WRONG (huge)	/FIXME (computed from TricepsTimingCalculator)
  loadDuration - OK (? - < 100 ms, which seems right)
  networkDuration - ?? (= 0, but working on localhost)	/FIXME (check calculation)
  pageVacillation - WRONG (always 1)	/was this so can do SQL to add # of hits?

// MysqlRawDataDAO
// Set from TTC - exclusively from writeNode?
rawdata 
  RawDataID	- OK
  instrument_session_id - OK
  InstrumentName - OK
  InstanceName - OK
  VarName - OK
  VarNum - BAD - always -1 - but is this really used?	/skip
  GroupNum - OK - it is using DisplayNum	/FIXME (but could be done within InstumentModel on load
  DisplayNum - OK 
  LangNum - OK, but using number from list of languages - should really use the Java ISO code (like "en" or "ru")	/FIXME (from InstrumentLoad)
  WhenAsMS - OK
  `TimeStamp` - OK, but do we really need both (is there an easy conversion between WhenAsMS and TimeStamp
  AnswerType - OK
  Answer - OK, but Unicode part not working.  The NullFlavor part is (*REFUSED*, *UNASKED*, etc.)	/FIXME (Unicode part)
  QuestionAsAsked - OK, but Unicode part not working	/FIXME (unicode part)
  itemVacillation - BAD - always 0	/FIXME - count # change events for a variable within EVENT_TIMING
  responseLatency - BAD - always 0	/FIXME - for a variable, time from focus to next event (as long as next event is not blur)
	// EventAggregate
	// // Evidence - from qtb 
	// PageHitBean (calls EventAggregate - the only function which calls it, via processEvents())
	// QuestionTimingBean (but not used)?
	// TricepsTimingCalculator (using QTB, but not set) (supposed to be?)
	// PageHitBean.processEvents() - it's store() called from TTC
  responseDuration - BAD - always 0	/FIXME - for a variable, time from focus to blur
  nullFlavor - BAD - always 0	/skip
  `Comment` - OK
  <crosspageItemVacillation> - ADD - Assuming have an in-memory representation of data (one row per item), increment it each time an item visited (changed? both?)

[FIXED] Concurrency - when trying to run two simultaneous sessions, they got confused - why?
---
10/9/2007

Unicode Debugging Notes
(1) MySQL does accurately store Unicode text (russian, Hebrew) if use PHPMyadmin to enter and save it.  So Mysql will be fine once can load proper data into it.
(2) Velocity Macros also print proper text (so Java Parser is working)
(3) .dat files OK
(4) .dat.evt files OK
(5) Entering unicode (Russian, Hebrew) into Dialogix data entry fields yields expected value - SO, Sufficiently working?
(6) Test jar/unjar of data - OK
(7) Test jar/unjar of instruments - BAD - when restore, the character values are wrong (but can avoid this by forcing use of .txt files
[ ] Test Mysql for unicode compatability (e.g. load results of Velocity Macros into a table
[ ] Log4J not showing unicode?

---
10/16/2007

Removed obsolete DB access parameters, interfaces and Beans (now 72 files)
Added DisplayNum to InstrumentSession and InstrumentSessionData tables

---
10/17/2007

[DONE] Check workflow - .store() events seem to occur at wrong time.  Page and Instrument should store right before returning to user?
[DONE] Fix lastAccess, statusMsg
[DONE] Confirm using correct GroupNum for pageHits and RawData
[DONE] Fix naming of groups - startingGroup, currentGroup, fromGroup, toGroup
[DONE] Fix naming of end_time => lastAccessTime
[DONE] Test concurrency - OK (as long as separate browsers, and thus separate sessions
[DONE] Removed delete() from all DB calls

[ ] Fix Timing information
	[ ] pageHits.FromGroup (always 0)	// consider just using AboutGroupNum (pre-change)? - NO
	[ ] pageHits.totalDuration (always 0)
	[ ] pageHits.loadDuration (always 0)
	[ ] pageHits.networkDuration (seems too high - probably because missing total & load)
	[ ] rawData.itemVascillation
	[ ] rawData.responseLatency
	[ ] rawData.responseDuration
	[ ] rawData.nullFlavor
[DONE] Fix Unicode
	[DONE] pageHitEvents.value1
	[DONE] pageHitEvents.value2
	[DONE] rawData.Answer
	[DONE] rawData.QuestionAsAsked
	[ ] rawData.Comment
[ ] Other
	[DONE] Remove InstrumentName from rawData and horizontal table (keep in Instrument)
	[DONE] Remove InstanceName from rawData and horizontal table (keep in Instrument)
	[DONE] Change table names to InstVer_NNNN (rather than  QAM, etc.) (instrumentVersion.instance_table_name)
	[DONE] Convert LangNum to LangCode (see Schedules.languagesISO)
	[DONE] Add LangCode to pageHits, InstrumentSession, HorizontalTable, and RawData to know what to expect
	[ ] Add prefix to _dlx_ variable names to avoid name clashes?
	[ ] Fix issue with language setting so that default is properly recorded.  Can it start in Hebrew?
	[ ] Add sample queries to confirm I can retrieve what is desired from the tables
	
[ ]? Remove uneeded paramaters (NO - will be replaced via JPA)
[ ] Incorporate JPA-based architecture
[ ] Extend Excel loader to point to new architecture
[ ] Stress testing? (to profile for potential leaks?)
[ ] What will it take to replace current Dialogix install with new one (on www.dialogix.org)?
[ ] Replace wave6users table?

-----
-- Notes from 10/31/2007
----
Critical ToDos
==TOM==
[ ] Finish persisting of full model from DialogixTimingCalculator
  [DONE] Horizontal Table 
  [DONE] DataElement - created, but not updated - do I need to add new objects?  Change persistence type? -- Check that data are being added -- also fix InstrumentContent_ID
  [DONE] PageUsage?
  [DONE] PageUsageEvents?
  [DONE] ItemUsage - fix InstrumentContent_ID
[DONE] Fix uniqueness constraints for Instrument, InstrumentVersion -- Annotate for George
[DONE] Create Inst_Ver_x table wheen upload a new InstrumentVersion (manually roll query) --in ExcelLoader
[DONE] Fix Sequence_Generator so only refers to tables being updated (e.g. remove InstVer4) -- do last 
[ ] Fix? uniqueness for Item, Question, Answer since LOINC mappings will occur at that level -- annotate for George
[ ] HL7 writer (minimal of 2.5, which can be hand-rolled from DataElement)- template for George
[ ] Financial questions - # NH, #staff each, salary of each, %having EMR/PHR.  What about coders for other CMS instruments?  Waste/fraud?
[ ] What happens with DB if there are errors - do I need to modularize error reporting and link to Excel?  OR, only upload to database if finalized  (and use that instead of JAR) -- SKIP?
[ ] Upload larger set of instruments for testing purposes
[DONE] Complete round-trip - upload Excel, collect data - both using JPA -- so populate ItemContents, etc. from Global Definition -- test that can load  instrument and populate DialogixTimingCalculator from InstrumentVersion ID
[ ] Why am I getting NullPointerException on second instrument load?
[ ] Assign AnswerID to result if  applicable (data_element and item_usage)
[ ] Consider re-naming classes?
  - InstrumentContents => Acts
  - ItemType => ActType
  - Item => Act
  - AnswerListContent => AnswerListEntry
[DONE] Re-do Entities to
  - Remove Inst_Ver_4
  - Add ConcatenatedAnswerList to Item - makes it easier to diplay output

Test Instruments
c:\bin\tomcat6\webapps\Demos\WEB-INF\schedules\DISC-combined.xls -- throws NullPointer - why?
c:\bin\tomcat6\webapps\Demos\WEB-INF\schedules\English-Russian-French-Demo.xls -- throws NullPointer - why?
c:\bin\tomcat6\webapps\Demos\WEB-INF\schedules\English-Russian-French-Hebrew-Demo.xls	-- works
c:\bin\tomcat6\webapps\Demos\WEB-INF\schedules\PHQ.xls -- works
c:\bin\tomcat6\webapps\Demos\WEB-INF\schedules\SF-36.xls -- throws NullPointer -- are the questions too long?


==GEORGE=
[ ] Apelon export (put data into their model and make sure can load it)
[ ] Apelon indexing - ensure can do word-level indexing for searching purposes (ask Jack if can't find it quickly)
[ ] Apelon import (TQL? into format needed by SemanticMapping tables?)
[ ] CCD Writer using SNOMED mapping codes
[ ] GUI for tasks related to Tutorial
[ ] GUI to show uploaded instruments and select from them to load an instrument

Optional Tasks
[ ] Map to XForms
[ ] Map to VoiceXML
[ ] Review Rachel Richesson's LOINC recommendations
[ ] Review ISO 11179 metadata issues - should any be  added to what we have?
[ ] 

Lingering WishList
[ ] Stress testing? (to profile for potential leaks?)
[ ] What will it take to replace current Dialogix install with new one (on www.dialogix.org)?
[ ] Replace wave6users table? (Study - user, instrument - will then point to InstrumentSession?)
[ ] Add prefix to _dlx_ variable names to avoid name clashes?
[ ] Fix issue with language setting so that default is properly recorded.  Can it start in Hebrew?
[ ] Fix Timing information
	[ ] pageHits.FromGroup (always 0)	// consider just using AboutGroupNum (pre-change)? - NO
	[ ] pageHits.totalDuration (always 0)
	[ ] pageHits.loadDuration (always 0)
	[ ] pageHits.networkDuration (seems too high - probably because missing total & load)
	[ ] rawData.itemVascillation
	[ ] rawData.responseLatency
	[ ] rawData.responseDuration
	[ ] rawData.nullFlavor
[ ] In-line JPA and PageHitBean into DialogixTimingCalculator
[ ] Extract DB parameters so can be configured at run-time	
[ ] What is lift to remove Datum and use DataElement within Parser?
[ ] Can data be properly re-loaded to resume a session state?

Wishlist of Views / Actions
- Uplaod Instrument - use button with Explorer window
 - will say whether successful or not - possibly a message saying user needs to create new version #
 - show a link to lauch and debug the instrument
- Select Instrument from list - pull from Instrument, InstrumentVersion, InstrumentHash - generate HTTP GET command to launch instrument
        http://www.dialogix.org:8080/BYS/servlet/Dialogix?schedule=BYS/WEB-INF/schedules/BYS-Adult.txt&DIRECTIVE=START
- LOINC 6 axes editting [optional]
 Property = FINDING, Time=PT, System=^PATIENT, Scale=dataType.LoincScale, Method=OBSERVED
 - [ ] George will modify PHP to do queries

- 

-- APELON --

TQL Export
	FROM [ROSI] EXPORT_CONCEPTS; 
		-- have to manually set save location for XML
		-- may not export SNOMED-specific parameters
		
		
Mapping

NameSpace = Instruments

Instrument.*
 InstrumentVersion.* (LOINC panel) [InstrumentVersion_ID]
  InstrumentContent.* (sequence) [call Actions instead of InstrumentContent?]
   Item.* (LOINC) [Item_ID] [call Action]
    Question 
     QuestionLocalized.*
    ItemType (Q,E) [ActionType - Item, Equation, Instruction]
    DataType (determines whether has AnswerList) [Optional if Instrruction]
    AnswerList
     AnswerListContent [call AnswerListEntry?]
      Answer.* (LAcode)[Answer_ID]
       AnswerLocalized.*
      AnswerOrder
      Value
   VarName [Property]
   Relevance [Property]
   
Contains vs. ContainedBy
Property Of (attribute)
Associated xxx (attribute)

Binding
 A =>
 Q =>
 QA =>
 IQA =>
 


   
   
 =====
 Notes for PHP Queries for George

--
-- Get all localized questions for a given Item
--
 
SELECT item.item_ID, item.itemType, question_localized.LanguageCode, question_localized.QuestionString
FROM item, question, question_localized
WHERE item.Question_ID = question.Question_ID
AND question_localized.question_ID = question.Question_ID
ORDER BY item.item_ID, question_localized.LanguageCode

--
-- Get all Answers and Values for items which have AnswerLists
--


SELECT item.item_ID, item.itemType, answer_list_content.Answer_Order, answer_list_content.Value, answer_localized.LanguageCode, answer_localized.AnswerString
FROM item, answer_list, answer_list_content, answer,answer_localized
WHERE item.AnswerList_ID = answer_list.AnswerList_ID
and answer_list.AnswerList_ID = answer_list_content.AnswerList_ID
and answer_list_content.Answer_ID = answer.Answer_ID
and answer.Answer_ID = answer_localized.Answer_ID
ORDER BY item.item_ID, answer_list_content.Answer_Order, answer_localized.LanguageCode;

--
-- Get all unique AnswerLists
--


SELECT answer_list.AnswerList_ID, answer_localized.LanguageCode, answer_list_content.Answer_Order, answer_list_content.Value, answer_localized.AnswerString
FROM answer_list, answer_list_content, answer,answer_localized
WHERE 
answer_list.AnswerList_ID = answer_list_content.AnswerList_ID
and answer_list_content.Answer_ID = answer.Answer_ID
and answer.Answer_ID = answer_localized.Answer_ID
ORDER BY answer_list.AnswerList_ID, answer_localized.LanguageCode, answer_list_content.Answer_Order;

--
-- Get all Questions, Answers and Values for items which have AnswerLists
--


SELECT item.item_ID, question_localized.LanguageCode, question_localized.QuestionString, answer_list_content.Answer_Order, answer_list_content.Value, answer_localized.LanguageCode, answer_localized.AnswerString
FROM item, question, question_localized, answer_list, answer_list_content, answer,answer_localized
WHERE item.AnswerList_ID = answer_list.AnswerList_ID
and answer_list.AnswerList_ID = answer_list_content.AnswerList_ID
and answer_list_content.Answer_ID = answer.Answer_ID
and answer.Answer_ID = answer_localized.Answer_ID
and item.Question_ID = question.Question_ID
and question_localized.question_ID = question.Question_ID
and question_localized.LanguageCode = answer_localized.LanguageCode
ORDER BY item.item_ID, question_localized.LanguageCode, answer_list_content.Answer_Order, answer_localized.LanguageCode;

===
== MDS Info
==
(1) On average, there are 2 MDS coordinators per Nursing Home
(2) There are between 16K and 17K nursing homes (was it thousand, or hundred)?
(3) If each coordinator makes $50K, then total cost of that staffing is 30k * 1650 * 2 - so $99 million (or 990 million) spent on that role which could be re-directed to care.